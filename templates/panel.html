
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Gestión de Asistencias</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #1E3A5F;
    --secondary: #4A6FA5;
    --accent: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --light: #f8f9fa;
    --dark: #343a40;
    --gray: #6c757d;
    --border: #dee2e6;
    --background: #f5f7fa;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--background);
    color: #333;
    line-height: 1.6;
    padding: 0;
    margin: 0;
    font-size: 0.9rem;
  }
  
  .container {
    display: grid;
    grid-template-columns: 220px 1fr;
    min-height: 100vh;
  }
  
  /* Sidebar */
  .sidebar {
    background: var(--primary);
    color: white;
    padding: 20px 0;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  
  .logo {
    padding: 0 20px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .logo h1 {
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .logo i {
    font-size: 1.5rem;
  }
  
  .menu-toggle {
    display: none;
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
  }
  
  .tabs {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 0 10px;
  }
  
  .tab-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.3s;
    text-align: left;
    font-size: 0.85rem;
  }
  
  .tab-btn:hover {
    background: rgba(255,255,255,0.1);
    color: white;
  }
  
  .tab-btn.active {
    background: var(--secondary);
    color: white;
  }
  
  .tab-btn i {
    width: 18px;
    text-align: center;
    font-size: 0.9rem;
  }
  
  /* Main Content */
  .main-content {
    padding: 15px;
    overflow: auto;
  }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  .header h2 {
    color: var(--primary);
    font-weight: 600;
    font-size: 1.3rem;
  }
  
  .live-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--danger);
    font-weight: 500;
  }
  
  .live-dot {
    width: 10px;
    height: 10px;
    background-color: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 6px rgba(220, 53, 69, 0);
    }
    100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
  }
  
  /* Actions */
  .actions {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  
  .btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
    font-size: 0.8rem;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: #2c5282;
  }
  
  .btn-success {
    background: var(--accent);
    color: white;
  }
  
  .btn-success:hover {
    background: #218838;
  }
  
  .btn-info {
    background: #17a2b8;
    color: white;
  }
  
  .btn-info:hover {
    background: #138496;
  }
  
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  
  .btn-danger:hover {
    background: #bd2130;
  }
  
  /* Table */
  .table-container {
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.05);
    overflow: auto;
    margin-bottom: 15px;
    max-height: 70vh;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  th, td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    font-size: 0.8rem;
    height: 32px;
    vertical-align: middle;
  }
  
  th {
    background-color: #f8f9fa;
    color: var(--dark);
    font-weight: 600;
    position: sticky;
    top: 0;
    box-shadow: 0 1px 0 var(--border);
    white-space: nowrap;
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background-color: #f8f9fa;
  }
  
  td[contenteditable="true"] {
    background: #fff;
    outline: 1px solid var(--primary);
    border-radius: 3px;
    padding: 6px 8px;
  }
  
  td.invalid-field {
    outline: 2px solid var(--danger);
    background-color: #fff5f5;
  }
  
  .actions-cell {
    display: flex;
    gap: 6px;
    white-space: nowrap;
  }
  
  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray);
    transition: color 0.3s;
    font-size: 0.9rem;
    padding: 3px;
    border-radius: 3px;
  }
  
  .icon-btn:hover {
    color: var(--primary);
    background: rgba(0,0,0,0.05);
  }
  
  .delete-btn:hover {
    color: var(--danger);
  }
  
  /* Paginación */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
  }
  
  .pagination-btn {
    padding: 6px 12px;
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
  }
  
  .pagination-btn:disabled {
    background-color: var(--gray);
    cursor: not-allowed;
  }
  
  .pagination-info {
    font-size: 0.8rem;
    color: var(--gray);
  }
  
  /* Estadísticas */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    position: relative;
  }
  
  .stat-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .stat-card h3 {
    color: var(--primary);
    margin: 0;
    font-size: 1rem;
  }
  
  .copy-btn {
    background: var(--light);
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    color: var(--dark);
    transition: background 0.3s;
  }
  
  .copy-btn:hover {
    background: var(--border);
  }
  
  .chart-container {
    position: relative;
    height: 250px;
  }
  
  /* Calendario de asistencias */
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-top: 15px;
  }
  
  .calendar-header {
    grid-column: span 7;
    text-align: center;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .calendar-nav {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    color: var(--primary);
  }
  
  .calendar-day {
    text-align: center;
    font-weight: 600;
    padding: 5px;
    background-color: #f8f9fa;
    border-radius: 3px;
  }
  
  .calendar-date {
    text-align: center;
    padding: 8px;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
  }
  
  .calendar-date.present {
    background-color: var(--accent);
    color: white;
  }
  
  .calendar-date.absent {
    background-color: #f8f9fa;
  }
  
  .calendar-date.today {
    border: 1px solid var(--primary);
  }
  
  /* Modal para calendario de asistencias */
  .calendar-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  
  .calendar-modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: auto;
  }
  
  .calendar-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .calendar-modal-header h3 {
    color: var(--primary);
    margin: 0;
  }
  
  .calendar-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
  }
  
  /* Modal para detalles de usuario */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  
  .modal-overlay.active {
    opacity: 1;
    pointer-events: all;
  }
  
  .modal {
    background: white;
    border-radius: 6px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--border);
  }
  
  .modal-header h3 {
    color: var(--primary);
    margin: 0;
    font-size: 1.1rem;
  }
  
  .close-btn {
    background: none;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
    color: var(--gray);
  }
  
  .modal-body {
    padding: 15px;
  }
  
  .user-info {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 15px;
  }
  
  .info-item {
    margin-bottom: 8px;
  }
  
  .info-label {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 3px;
    font-size: 0.8rem;
  }
  
  .info-value {
    color: var(--gray);
    font-size: 0.85rem;
  }
  
  /* Notifications */
  .notification {
    position: fixed;
    top: 15px;
    right: 15px;
    padding: 12px 15px;
    border-radius: 5px;
    color: white;
    opacity: 0;
    transition: opacity 0.5s;
    z-index: 1000;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    font-size: 0.85rem;
  }
  
  .success {
    background: var(--accent);
  }
  
  .error {
    background: var(--danger);
  }
  
  /* Loading */
  .loading {
    display: none;
    text-align: center;
    margin: 15px;
  }
  
  /* ---------- Forzar layout de la tabla y fijar columna Acciones ---------- */
  .table-container table {
    table-layout: fixed; /* columnas respetan los anchos declarados (no se reajustan por contenido) */
    width: 100%;
  }
  
  /* Columna de acciones (col class) — ajustar ancho si hace falta */
  .table-container col.actions-col {
    width: 90px; /* cámbialo por 70/80/100 según prefieras */
  }
  
  /* Asegurar celdas con overflow controlado */
  .table-container th,
  .table-container td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Layout de la celda acciones */
  .actions-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 0 6px;
    height: 40px;             /* fuerza altura uniforme para la celda de acciones */
    box-sizing: border-box;
    overflow: hidden;
  }
  
  /* Estilo ligero para los íconos clickeables */
  .action-icon {
    display: inline-block;
    width: 20px;
    height: 20px;
    line-height: 20px;
    font-size: 16px;
    cursor: pointer;
    color: var(--gray);
    text-align: center;
    vertical-align: middle;
    margin: 0;
    padding: 0;
  }
  
  /* hover states */
  .action-icon:hover { color: var(--primary); }
  .delete-icon:hover  { color: var(--danger); }
  
  /* Reset de estilos si aún quedan botones dentro de tablas */
  .table-container .icon-btn {
    margin: 0;
    padding: 0;
    border: none;
    background: transparent;
    box-shadow: none;
    outline: none;
  }
  
  /* Vista de cuadro de asistencias */
  .cuadro-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .cuadro-nav {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .cuadro-title {
    font-weight: 600;
    color: var(--primary);
  }
  
  .asistencia-si {
    background-color: var(--accent);
    color: white;
    text-align: center;
    border-radius: 3px;
    padding: 3px 5px;
  }
  
  .asistencia-no {
    background-color: #f8f9fa;
    text-align: center;
    border-radius: 3px;
    padding: 3px 5px;
  }
    
  .spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    width: 25px;
    height: 25px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Progress Bar */
  .progress-container {
    margin: 20px 0;
    border-radius: 5px;
    overflow: hidden;
    background-color: #e9ecef;
    height: 20px;
  }
  
  .progress-bar {
    height: 100%;
    background-color: var(--accent);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
  }
  
  /* Responsive */
  @media (max-width: 900px) {
    .container {
      grid-template-columns: 1fr;
      position: relative;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 1000;
      transform: translateX(-100%);
    }
    
    .sidebar.active {
      transform: translateX(0);
    }
    
    .menu-toggle {
      display: block;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1001;
      background: var(--primary);
      border-radius: 5px;
      padding: 5px 10px;
    }
    
    .main-content {
      padding-top: 60px;
    }
    
    .actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    .btn {
      justify-content: center;
    }
    
    .user-info {
      grid-template-columns: 1fr;
    }
    
    .stats-container {
      grid-template-columns: 1fr;
    }
    
    .calendar {
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
    }
    
    .calendar-date {
      padding: 5px;
      font-size: 0.8rem;
    }
    
    /* Mejora para botones en vista móvil */
    .actions-cell {
      flex-direction: row;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .actions-cell .icon-btn {
      margin: 2px;
    }
    
    /* Ajustes para el cuadro de asistencias en móviles */
    .cuadro-header {
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
    }
    
    .table-container.cuadro-table {
      overflow-x: auto;
    }
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<!-- SheetJS (para exportar a Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2canvas para copiar gráficos -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<button class="menu-toggle" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <h1><i class="fas fa-user-graduate"></i> SIGA</h1>
      <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="tabs">
      
      <button class="tab-btn active" onclick="cambiarTab('alumnos')">
        <i class="fas fa-users"></i> Alumnos
      </button>
      
      <button class="tab-btn" onclick="cambiarTab('asistencias')">
        <i class="fas fa-clipboard-check"></i> Asistencias
      </button>      
      
      <button class="tab-btn" onclick="cambiarTab('estadisticas')">
        <i class="fas fa-chart-pie"></i> Estadísticas
      </button>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h2 id="tableTitle">Gestión de Alumnos</h2>
      <div class="live-indicator">
        <div class="live-dot"></div>
        <span>En vivo</span>
      </div>
    </div>
    
    <div id="content-container">
      <!-- Contenido para la pestaña de Alumnos -->
      <div id="alumnos-content">
        <div class="actions">
          <button class="btn btn-primary" onclick="agregarFila()">
            <i class="fas fa-plus"></i> Agregar Fila
          </button>
          <button class="btn btn-success" id="saveBtn" disabled>
            <i class="fas fa-save"></i> Guardar Cambios
          </button>
          <button class="btn btn-info" onclick="exportToExcel()">
            <i class="fas fa-file-export"></i> Exportar a Excel
          </button>
          
          <button class="btn btn-info" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-file-import"></i> Actualizar desde Excel
          </button>
          <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelUpload(event)">
        </div>
        
        <div class="table-container">
          <table id="dataTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        
        <!-- Paginación -->
        <div class="pagination" id="paginationControls">
          <button class="pagination-btn" id="prevPage" disabled onclick="cambiarPagina('anterior')">Anterior</button>
          <span class="pagination-info" id="pageInfo">Página 1 de 1</span>
          <button class="pagination-btn" id="nextPage" disabled onclick="cambiarPagina('siguiente')">Siguiente</button>
        </div>
      </div>
      
      <!-- Contenido para la pestaña de Asistencias -->
      <div id="asistencias-content" style="display: none;">
        <div class="actions">
          <button class="btn btn-info" onclick="cambiarVistaAsistencias('resumen')">
            <i class="fas fa-list"></i> Vista Resumen
          </button>
          <button class="btn btn-info" onclick="cambiarVistaAsistencias('cuadro')">
            <i class="fas fa-table"></i> Vista Cuadro
          </button>
          <button class="btn btn-primary" onclick="cambiarSemana(-1)">
            <i class="fas fa-chevron-left"></i> Semana Anterior
          </button>
          <button class="btn btn-primary" onclick="cambiarSemana(1)">
            Semana Siguiente <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        
        <!-- Vista Resumen -->
        <div id="vista-resumen">
          <div class="table-container">
            <table id="asistenciasTable">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Total Asistencias</th>
                  <th>Última Asistencia</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="asistenciasBody">
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Vista Cuadro -->
        <div id="vista-cuadro" style="display: none;">
          <div class="cuadro-header">
            <div class="cuadro-nav">
              <span class="cuadro-title" id="rango-fechas">Cargando...</span>
            </div>
          </div>
          <div class="table-container cuadro-table">
            <table id="cuadroAsistenciasTable">
              <thead id="cuadroAsistenciasHead">
              </thead>
              <tbody id="cuadroAsistenciasBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Contenido para la pestaña de Estadísticas -->
      <div id="estadisticas-content" style="display: none;">
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-card-header">
              <h3>Distribución por Carrera</h3>
            </div>
            <div class="chart-container">
              <canvas id="carreraChart"></canvas>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-header">
              <h3>Distribución por Región</h3>
            </div>
            <div class="chart-container">
              <canvas id="regionChart"></canvas>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-card-header">
              <h3>Distribución por Modalidad</h3>
            </div>
            <div class="chart-container">
              <canvas id="modalidadChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="loading" id="loadingIndicator">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
  </div>
</div>

<!-- Modal para calendario de asistencias -->
<div class="calendar-modal" id="calendarModal">
  <div class="calendar-modal-content">
    <div class="calendar-modal-header">
      <h3 id="calendarTitle">Asistencias de </h3>
      <button class="calendar-close" onclick="closeCalendarModal()">&times;</button>
    </div>
    <div id="calendarContainer"></div>
  </div>
</div>

<!-- Modal para importar Excel -->
<div class="modal-overlay" id="excelModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Opciones de importación</h3>
      <button class="close-btn" onclick="closeExcelModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>¿Cómo desea importar los datos?</p>
      <div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
        <button class="btn btn-danger" onclick="processExcelData('replace')">Reemplazar todos los datos actuales</button>
        <button class="btn btn-primary" onclick="processExcelData('add')">Agregar nueva información</button>
      </div>
      <div id="progressContainer" style="display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span id="progressStatus">Cargando...</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-container">
          <div id="progressBar" class="progress-bar">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para detalles de usuario -->
<div class="modal-overlay" id="userModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Detalles del Alumno</h3>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="userModalBody">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
  // Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCohuXeXlI6z8R0RXEIWeL4atI9zkpj_i4",
    authDomain: "academia-udep-43440.firebaseapp.com",
    projectId: "academia-udep-43440",
    storageBucket: "academia-udep-43440.firebasestorage.app",
    messagingSenderId: "853553587165",
    appId: "1:853553587165:web:d2fd928f520d51276e4c34"
  };
  
  // Inicializar Firebase
  try {
    firebase.initializeApp(firebaseConfig);
  } catch (error) {
    console.error("Error inicializando Firebase: ", error);
    showNotification("Error inicializando Firebase", "error");
  }
  
  const db = firebase.firestore();
  let coleccionActual = "alumnos";
  let datosLocal = {};
  let cambiosPendientes = false;
  let allKeys = [];
  let unsubscribe = null;
  let charts = {};
  let alumnosData = [];
  let asistenciasData = [];
  let asistenciasPorAlumno = {};
  
  // Variables para paginación
  let lastVisible = null;
  let firstVisible = null;
  let currentPage = 1;
  let totalPages = 1;
  const limit = 50;

  // Variables para la vista de cuadro de asistencias
  let fechaInicioSemana = new Date();
  let vistaAsistenciasActual = 'resumen'; // 'resumen' o 'cuadro'

  // Ajustar la fecha al inicio de la semana (lunes)
  fechaInicioSemana.setDate(fechaInicioSemana.getDate() - fechaInicioSemana.getDay() + (fechaInicioSemana.getDay() === 0 ? -6 : 1));
  fechaInicioSemana.setHours(0, 0, 0, 0);

  // Referencias a elementos del DOM
  const saveBtn = document.getElementById("saveBtn");
  const loadingIndicator = document.getElementById("loadingIndicator");
  const notificationElement = document.getElementById("notification");
  const tableTitle = document.getElementById("tableTitle");
  const userModal = document.getElementById("userModal");
  const userModalBody = document.getElementById("userModalBody");
  const alumnosContent = document.getElementById("alumnos-content");
  const asistenciasContent = document.getElementById("asistencias-content");
  const estadisticasContent = document.getElementById("estadisticas-content");
  const sidebar = document.getElementById("sidebar");
  const calendarModal = document.getElementById("calendarModal");
  const calendarContainer = document.getElementById("calendarContainer");
  const calendarTitle = document.getElementById("calendarTitle");
  const prevPageBtn = document.getElementById("prevPage");
  const nextPageBtn = document.getElementById("nextPage");
  const pageInfo = document.getElementById("pageInfo");
  const vistaResumen = document.getElementById("vista-resumen");
  const vistaCuadro = document.getElementById("vista-cuadro");
  const rangoFechas = document.getElementById("rango-fechas");

  // Variable para navegación del calendario
  let currentCalendarMonth = new Date().getMonth();
  let currentCalendarYear = new Date().getFullYear();
  let currentCalendarDni = "";

  // Variables para importación de Excel
  let excelData = [];
  let excelHeaders = [];

  function toggleSidebar() {
    sidebar.classList.toggle('active');
  }

  function showNotification(message, type = "success") {
    notificationElement.textContent = message;
    notificationElement.className = `notification ${type}`;
    notificationElement.style.opacity = 1;
    
    setTimeout(() => {
      notificationElement.style.opacity = 0;
    }, 3000);
  }

  function cambiarTab(tab) {
    if (cambiosPendientes && tab !== coleccionActual) {
      if (!confirm("Tienes cambios sin guardar. ¿Estás seguro de que quieres cambiar de pestaña?")) {
        return;
      }
    }
    
    coleccionActual = tab;
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelector(`.tab-btn[onclick="cambiarTab('${tab}')"]`).classList.add("active");
    
    // Ocultar todos los contenidos primero
    alumnosContent.style.display = 'none';
    asistenciasContent.style.display = 'none';
    estadisticasContent.style.display = 'none';
    
    // Actualizar título y contenido según la pestaña
    if (tab === 'estadisticas') {
      tableTitle.textContent = 'Estadísticas de Alumnos';
      estadisticasContent.style.display = 'block';
      cargarEstadisticas();
    } else if (tab === 'asistencias') {
      tableTitle.textContent = 'Gestión de Asistencias';
      asistenciasContent.style.display = 'block';
      cargarAsistencias();
    } else {
      tableTitle.textContent = 'Gestión de Alumnos';
      alumnosContent.style.display = 'block';
      
      // Cargar datos de la nueva colección
      cargarTabla();
    }
    
    // En móvil, cerrar el sidebar al cambiar de pestaña
    if (window.innerWidth <= 900) {
      sidebar.classList.remove('active');
    }
  }

  function cambiarVistaAsistencias(vista) {
    vistaAsistenciasActual = vista;
    
    if (vista === 'resumen') {
      vistaResumen.style.display = 'block';
      vistaCuadro.style.display = 'none';
    } else {
      vistaResumen.style.display = 'none';
      vistaCuadro.style.display = 'block';
      cargarCuadroAsistencias();
    }
  }

  function cambiarSemana(direccion) {
    fechaInicioSemana.setDate(fechaInicioSemana.getDate() + (direccion * 7));
    if (vistaAsistenciasActual === 'cuadro') {
      cargarCuadroAsistencias();
    }
  }

  function formatearValor(valor) {
    if (valor === null || valor === undefined) return "";
    
    // Si es un timestamp de Firestore
    if (valor && typeof valor.toDate === 'function') {
      return valor.toDate().toLocaleString("es-ES");
    }
    
    // Si es un objeto (pero no un timestamp)
    if (typeof valor === 'object') {
      return JSON.stringify(valor);
    }
    
    return valor;
  }

  function cargarTabla() {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");
    
    head.innerHTML = "";
    body.innerHTML = "";
    datosLocal = {};
    cambiosPendientes = false;
    saveBtn.disabled = true;
    
    loadingIndicator.style.display = "block";

    // Cancelar suscripción anterior si existe
    if (unsubscribe) {
      unsubscribe();
    }

    // Obtener el total de documentos para la paginación
    db.collection("registros").get().then(snapshot => {
      totalPages = Math.ceil(snapshot.size / limit);
      updatePaginationControls();
    });

    // Usar onSnapshot para sincronización en tiempo real con paginación
    let query = db.collection("registros").orderBy("nombre").limit(limit);
    
    if (currentPage > 1 && lastVisible) {
      query = query.startAfter(lastVisible);
    }
    
    unsubscribe = query.onSnapshot(snapshot => {
      loadingIndicator.style.display = "none";
      
      head.innerHTML = "";
      body.innerHTML = "";
      
      if (snapshot.empty) {
        head.innerHTML = "<tr><th colspan='3'>No hay datos en esta colección</th></tr>";
        return;
      }

      // Guardar el último documento visible para la paginación
      lastVisible = snapshot.docs[snapshot.docs.length-1];
      
      // Obtener todas las claves únicas de todos los documentos
      allKeys = new Set();
      snapshot.forEach(doc => {
        Object.keys(doc.data()).forEach(key => allKeys.add(key));
      });
      
      // Convertir a array y ordenar según el orden deseado
      allKeys = Array.from(allKeys);
      
      // Orden personalizado para la colección registros
      const ordenDeseado = ['nombre', 'dni', 'carrera', 'region', 'modalidad', 'celular', 'fecha'];
      allKeys = ordenDeseado.filter(key => allKeys.includes(key));
      
      // Agregar cualquier campo adicional que no esté en el orden deseado
      const camposAdicionales = allKeys.filter(key => !ordenDeseado.includes(key));
      allKeys = allKeys.concat(camposAdicionales);
      
      // Eliminar totalAsistencias de las columnas mostradas
      allKeys = allKeys.filter(key => key !== 'totalAsistencias');
      
      // Crear encabezados
      let trHead = "<tr>";
      allKeys.forEach(k => { 
        trHead += `<th>${k}</th>`; 
      });
      
      // Agregar columna de acciones
      trHead += "<th>Acciones</th></tr>";
      
      head.innerHTML = trHead;
      
      // --- crear/actualizar colgroup para que la última columna sea actions-col (ancho fijo) ---
      const dataTable = document.getElementById('dataTable');
      let colgroup = dataTable.querySelector('colgroup');
      if (!colgroup) {
        colgroup = document.createElement('colgroup');
        dataTable.insertBefore(colgroup, dataTable.firstChild);
      }
      colgroup.innerHTML = '';
      // una <col> por cada columna de allKeys
      for (let i = 0; i < allKeys.length; i++) {
        colgroup.appendChild(document.createElement('col'));
      }
      // col para la columna Acciones
      const actionsCol = document.createElement('col');
      actionsCol.className = 'actions-col';
      colgroup.appendChild(actionsCol);
            

      // Crear filas
      snapshot.forEach(doc => {
        const data = doc.data();
        datosLocal[doc.id] = {...data}; // Guardar copia local
        
        let tr = `<tr data-id="${doc.id}">`;
        
        allKeys.forEach(k => {
          const valor = data[k];
          tr += `<td contenteditable="true" data-key="${k}" oninput="habilitarGuardado()" onblur="validarCampo(this, '${k}')">${formatearValor(valor)}</td>`;
        });
        
        // Botones de acción

        tr += `<td class="actions-cell">`;
        tr += `<i class="fas fa-eye action-icon" title="Ver detalles" onclick="verDetallesAlumno('${doc.id}')"></i>`;
        tr += `<i class="fas fa-trash action-icon delete-icon" title="Eliminar" onclick="eliminarFila('${doc.id}', 'registros')"></i>`;
        tr += `</td>`;

        body.innerHTML += tr;
      });
    }, error => {
      loadingIndicator.style.display = "none";
      console.error("Error cargando datos: ", error);
      showNotification("Error cargando datos: " + error.message, "error");
    });
  }

  function cambiarPagina(direction) {
    if (direction === 'siguiente' && currentPage < totalPages) {
      currentPage++;
      cargarTabla();
    } else if (direction === 'anterior' && currentPage > 1) {
      currentPage--;
      cargarTabla();
    }
  }

  function updatePaginationControls() {
    pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage === totalPages;
  }

  function validarCampo(campo, key) {
    const valor = campo.textContent.trim();
    
    // Remover estado de error previo
    campo.classList.remove('invalid-field');
    
    // Validaciones según el tipo de campo
    if (key === 'dni' && valor !== '' && !/^\d{8}$/.test(valor)) {
      campo.classList.add('invalid-field');
      showNotification("El DNI debe tener exactamente 8 dígitos numéricos", "error");
      return false;
    }
    
    if (key === 'celular' && valor !== '' && !/^\d{9}$/.test(valor)) {
      campo.classList.add('invalid-field');
      showNotification("El celular debe tener exactamente 9 dígitos numéricos", "error");
      return false;
    }
    
    if (key === 'fecha' && valor !== '') {
      // Intentar parsear la fecha
      const fecha = new Date(valor);
      if (isNaN(fecha.getTime())) {
        campo.classList.add('invalid-field');
        showNotification("Formato de fecha inválido. Use formato: DD/MM/AAAA", "error");
        return false;
      }
    }
    
    return true;
  }

  function cargarAsistencias() {
    loadingIndicator.style.display = "block";
    
    // Obtener todos los registros de alumnos
    db.collection("registros").get().then(registrosSnapshot => {
      alumnosData = [];
      registrosSnapshot.forEach(doc => {
        alumnosData.push({ id: doc.id, ...doc.data() });
      });
      
      // Obtener todas las asistencias con caché para mejor rendimiento
      return db.collection("asistencias").orderBy("fecha", "desc").get();
    }).then(asistenciasSnapshot => {
      asistenciasData = [];
      asistenciasSnapshot.forEach(doc => {
        asistenciasData.push({ id: doc.id, ...doc.data() });
      });
      
      // Procesar datos para mostrar asistencias por alumno
      procesarAsistenciasPorAlumno();
      loadingIndicator.style.display = "none";
      
      // Mostrar la vista actual
      if (vistaAsistenciasActual === 'resumen') {
        mostrarAsistenciasPorAlumno();
      } else {
        cargarCuadroAsistencias();
      }
    }).catch(error => {
      loadingIndicator.style.display = "none";
      console.error("Error cargando asistencias: ", error);
      showNotification("Error cargando asistencias: " + error.message, "error");
    });
  }

  function procesarAsistenciasPorAlumno() {
    // Reiniciar el objeto de asistencias por alumno
    asistenciasPorAlumno = {};
    
    // Procesar cada asistencia
    asistenciasData.forEach(asistencia => {
      const dni = asistencia.dni;
      
      // Si no existe el alumno en el objeto, inicializarlo
      if (!asistenciasPorAlumno[dni]) {
        asistenciasPorAlumno[dni] = {
          total: 0,
          ultimaFecha: null,
          fechas: new Set() // Usamos Set para evitar duplicados por fecha
        };
      }
      
      // Procesar la fecha de la asistencia
      if (asistencia.fecha && typeof asistencia.fecha.toDate === 'function') {
        const fecha = asistencia.fecha.toDate();
        const fechaStr = fecha.toISOString().split('T')[0]; // YYYY-MM-DD
        
        // Solo contar una asistencia por día (evitar duplicados)
        if (!asistenciasPorAlumno[dni].fechas.has(fechaStr)) {
          asistenciasPorAlumno[dni].fechas.add(fechaStr);
          asistenciasPorAlumno[dni].total++;
          
          // Actualizar la última fecha si es más reciente
          if (!asistenciasPorAlumno[dni].ultimaFecha || fecha > asistenciasPorAlumno[dni].ultimaFecha) {
            asistenciasPorAlumno[dni].ultimaFecha = fecha;
          }
        }
      }
    });
  }

  function mostrarAsistenciasPorAlumno() {
    const asistenciasBody = document.getElementById("asistenciasBody");
    asistenciasBody.innerHTML = "";
    
    // Crear filas para cada alumno
    alumnosData.forEach(alumno => {
      const dni = alumno.dni;
      const asistencias = asistenciasPorAlumno[dni] || { total: 0, ultimaFecha: null, fechas: new Set() };
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${alumno.nombre || 'No especificado'}</td>
        <td>${dni || 'No especificado'}</td>
        <td>${asistencias.total}</td>
        <td>${asistencias.ultimaFecha ? asistencias.ultimaFecha.toLocaleDateString() : 'Nunca'}</td>

        
        <td class="actions-cell">
          ${asistencias.total > 0 ? `
            <i class="fas fa-calendar-alt action-icon" title="Ver calendario de asistencias"
               onclick="mostrarCalendarioAsistencias('${dni}', '${alumno.nombre}')"></i>
          ` : ''}
        </td>        
        
      `;
      
      asistenciasBody.appendChild(tr);
    });
  }

  function cargarCuadroAsistencias() {
    const cuadroHead = document.getElementById("cuadroAsistenciasHead");
    const cuadroBody = document.getElementById("cuadroAsistenciasBody");
    
    loadingIndicator.style.display = "block";
    cuadroHead.innerHTML = "";
    cuadroBody.innerHTML = "";
    
    // Calcular fechas de la semana
    const fechaFinSemana = new Date(fechaInicioSemana);
    fechaFinSemana.setDate(fechaInicioSemana.getDate() + 6);
    
    // Actualizar el texto del rango de fechas
    const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
    rangoFechas.textContent = `Semana: ${fechaInicioSemana.toLocaleDateString('es-ES', opciones)} - ${fechaFinSemana.toLocaleDateString('es-ES', opciones)}`;
    
    // Crear encabezados de la tabla
    let trHead = "<tr><th>Alumno</th><th>DNI</th>";
    const diasSemana = [];
    
    for (let i = 0; i < 7; i++) {
      const fecha = new Date(fechaInicioSemana);
      fecha.setDate(fechaInicioSemana.getDate() + i);
      const fechaStr = fecha.toISOString().split('T')[0];
      diasSemana.push(fechaStr);
      
      trHead += `<th>${fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}</th>`;
    }
    
    trHead += "</tr>";
    cuadroHead.innerHTML = trHead;
    
    // Crear filas para cada alumno
    alumnosData.forEach(alumno => {
      const dni = alumno.dni;
      const asistencias = asistenciasPorAlumno[dni] || { total: 0, ultimaFecha: null, fechas: new Set() };
      
      let tr = `<tr><td>${alumno.nombre || 'No especificado'}</td><td>${dni || 'No especificado'}</td>`;
      
      // Para cada día de la semana, verificar asistencia
      diasSemana.forEach(dia => {
        const asistio = asistencias.fechas.has(dia);
        tr += `<td class="${asistio ? 'asistencia-si' : 'asistencia-no'}">${asistio ? 'SI' : 'NO'}</td>`;
      });
      
      tr += "</tr>";
      cuadroBody.innerHTML += tr;
    });
    
    loadingIndicator.style.display = "none";
  }

  function mostrarCalendarioAsistencias(dni, nombre) {
    const asistencias = asistenciasPorAlumno[dni] || { total: 0, ultimaFecha: null, fechas: new Set() };
    
    // Guardar el DNI actual para la navegación del calendario
    currentCalendarDni = dni;
    
    // Actualizar el título del modal
    calendarTitle.textContent = `Asistencias de ${nombre} (DNI: ${dni})`;
    
    // Generar el calendario
    generarCalendario(asistencias.fechas);
    
    // Mostrar el modal
    calendarModal.style.display = 'flex';
  }

  function cambiarMesCalendario(direction) {
    if (direction === 'next') {
      currentCalendarMonth++;
      if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
    } else {
      currentCalendarMonth--;
      if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
    }
    
    // Regenerar el calendario con el nuevo mes
    const asistencias = asistenciasPorAlumno[currentCalendarDni] || { total: 0, ultimaFecha: null, fechas: new Set() };
    generarCalendario(asistencias.fechas);
  }

  function generarCalendario(fechasAsistencia) {
    // Obtener el mes y año actual para el calendario
    const mes = currentCalendarMonth;
    const año = currentCalendarYear;
    
    // Obtener el primer día del mes
    const primerDia = new Date(año, mes, 1);
    // Obtener el último día del mes
    const ultimoDia = new Date(año, mes + 1, 0);
    
    // Días de la semana
    const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    
    // Obtener la fecha actual para resaltar el día actual
    const hoy = new Date();
    const esMesActual = hoy.getMonth() === mes && hoy.getFullYear() === año;
    
    // Crear el HTML del calendario
    let html = `
      <div class="calendar-header">
        <button class="calendar-nav" onclick="cambiarMesCalendario('prev')">
          <i class="fas fa-chevron-left"></i>
        </button>
        <div>${primerDia.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</div>
        <button class="calendar-nav" onclick="cambiarMesCalendario('next')">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="calendar">
    `;
    
    // Agregar los días de la semana
    for (let i = 0; i < 7; i++) {
      html += `<div class="calendar-day">${diasSemana[i]}</div>`;
    }
    
    // Agregar espacios vacíos para los días antes del primer día del mes
    for (let i = 0; i < primerDia.getDay(); i++) {
      html += `<div class="calendar-date absent"></div>`;
    }
    
    // Agregar los días del mes
    for (let i = 1; i <= ultimoDia.getDate(); i++) {
      const fechaStr = `${año}-${String(mes + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
      const asistio = fechasAsistencia.has(fechaStr);
      const esHoy = esMesActual && i === hoy.getDate();
      
      html += `<div class="calendar-date ${asistio ? 'present' : 'absent'} ${esHoy ? 'today' : ''}">${i}</div>`;
    }
    
    html += `</div>`;
    
    // Insertar el calendario en el contenedor
    calendarContainer.innerHTML = html;
  }

  function closeCalendarModal() {
    calendarModal.style.display = 'none';
    // Restablecer el calendario al mes actual
    currentCalendarMonth = new Date().getMonth();
    currentCalendarYear = new Date().getFullYear();
  }

  function cargarEstadisticas() {
    loadingIndicator.style.display = "block";
    
    // Obtener todos los alumnos
    db.collection('registros').get().then(snapshot => {
      loadingIndicator.style.display = "none";
      
      if (snapshot.empty) {
        showNotification("No hay datos para mostrar estadísticas", "error");
        return;
      }
      
      const datos = [];
      snapshot.forEach(doc => {
        datos.push(doc.data());
      });
      
      // Procesar datos para estadísticas
      procesarDatosEstadisticas(datos);
    }).catch(error => {
      loadingIndicator.style.display = "none";
      console.error("Error cargando estadísticas: ", error);
      showNotification("Error cargando estadísticas: " + error.message, "error");
    });
  }

  function procesarDatosEstadisticas(datos) {
    // Estadísticas por carrera
    const carreras = {};
    datos.forEach(alumno => {
      const carrera = alumno.carrera || 'Sin especificar';
      carreras[carrera] = (carreras[carrera] || 0) + 1;
    });
    
    // Estadísticas por región
    const regiones = {};
    datos.forEach(alumno => {
      const region = alumno.region || 'Sin especificar';
      regiones[region] = (regiones[region] || 0) + 1;
    });
    
    // Estadísticas por modalidad
    const modalidades = {};
    datos.forEach(alumno => {
      const modalidad = alumno.modalidad || 'Sin especificar';
      modalidades[modalidad] = (modalidades[modalidad] || 0) + 1;
    });
    
    // Crear gráficos
    crearGrafico('carreraChart', 'Carreras', carreras);
    crearGrafico('regionChart', 'Regiones', regiones);
    crearGrafico('modalidadChart', 'Modalidades', modalidades);
  }

  function crearGrafico(canvasId, titulo, datos) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Destruir gráfico existente si hay uno
    if (charts[canvasId]) {
      charts[canvasId].destroy();
    }
    
    // Preparar datos para el gráfico - mostrar solo las 5 principales y agrupar el resto como "Otros"
    let labels = Object.keys(datos);
    let values = Object.values(datos);
    
    // Si hay más de 5 categorías, agrupar las menos significativas como "Otros"
    if (labels.length > 5) {
      // Crear array de objetos para ordenar
      const dataArray = labels.map((label, index) => {
        return { label: label, value: values[index] };
      });
      
      // Ordenar de mayor a menor
      dataArray.sort((a, b) => b.value - a.value);
      
      // Tomar las 5 principales
      const top5 = dataArray.slice(0, 5);
      
      // Sumar el resto
      const otrosValue = dataArray.slice(5).reduce((sum, item) => sum + item.value, 0);
      
      // Reconstruir labels and values
      labels = top5.map(item => item.label);
      values = top5.map(item => item.value);
      
      // Agregar "Otros" si hay valores
      if (otrosValue > 0) {
        labels.push('Otros');
        values.push(otrosValue);
      }
    }
    
    // Calcular total para porcentajes
    const total = values.reduce((a, b) => a + b, 0);
    
    // Colores para el gráfico
    const backgroundColors = [
      '#1E3A5F', '#4A6FA5', '#28a745', '#dc3545', '#ffc107', 
      '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14', '#20c997'
    ];
    
    charts[canvasId] = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels.map((label, i) => {
          const percentage = ((values[i] / total) * 100).toFixed(1);
          return `${label}: ${percentage}% (${values[i]})`;
        }),
        datasets: [{
          data: values,
          backgroundColor: backgroundColors,
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 15,
              padding: 15,
              font: {
                family: 'Arial',
                size: 13
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label.split(':')[0]}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }

  function habilitarGuardado() {
    cambiosPendientes = true;
    saveBtn.disabled = false;
  }

  function agregarFila() {
    // Crear un nuevo documento con valores por defecto
    const nuevoDocRef = db.collection("registros").doc();
    const datosPorDefecto = {
      nombre: '',
      dni: '',
      carrera: '',
      region: '',
      modalidad: '',
      celular: '',
      fecha: firebase.firestore.FieldValue.serverTimestamp(),
      totalAsistencias: 0
    };
    
    nuevoDocRef.set(datosPorDefecto)
      .then(() => {
        showNotification("Nueva fila agregada");
      })
      .catch(error => {
        console.error("Error agregando fila: ", error);
        showNotification("Error agregando fila: " + error.message, "error");
      });
  }

  function eliminarFila(docId, collectionName = "registros") {
    if (confirm("¿Estás seguro de que deseas eliminar esta fila?")) {
      db.collection(collectionName).doc(docId).delete()
        .then(() => {
          showNotification("Fila eliminada correctamente");
        })
        .catch(error => {
          console.error("Error eliminando fila: ", error);
          showNotification("Error eliminando fila: " + error.message, "error");
        });
    }
  }

  function verDetallesAlumno(userId) {
    console.log("Intentando ver detalles del ID:", userId);
    loadingIndicator.style.display = "block";
    
    // Obtener datos del alumno desde la colección "registros"
    db.collection('registros').doc(userId).get().then(userDoc => {
        if (!userDoc.exists) {
            showNotification("Alumno no encontrado", "error");
            loadingIndicator.style.display = "none";
            return;
        }
        
        const userData = userDoc.data();
        console.log("Datos del alumno:", userData);
        
        // Construir el modal con la información del alumno
        userModalBody.innerHTML = `
            <div class="user-info">
                
                <div class="info-item">
                    <div class="info-label">Nombre</div>
                    <div class="info-value">${userData.nombre || 'No especificado'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">DNI</div>
                    <div class="info-value">${userData.dni || 'No especificado'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Carrera</div>
                    <div class="info-value">${userData.carrera || 'No especificado'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Región</div>
                    <div class="info-value">${userData.region || 'No especificado'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Modalidad</div>
                    <div class="info-value">${userData.modalidad || userData.mediidad || 'No especificada'}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Celular</div>
                    <div class="info-value">${userData.celular || 'No especificado'}</div>
                </div>
                

                
                <div class="info-item">
                    <div class="info-label">Fecha de registro</div>
                    <div class="info-value">${userData.fecha ? (typeof userData.fecha.toDate === 'function' ? userData.fecha.toDate().toLocaleDateString() : userData.fecha) : 'No especificado'}</div>
                </div>
            </div>
        `;
        
        // Mostrar el modal
        userModal.classList.add('active');
        loadingIndicator.style.display = "none";
    })
    .catch(error => {
        loadingIndicator.style.display = "none";
        console.error("Error obteniendo alumno:", error);
        showNotification("Error obteniendo datos del alumno: " + error.message, "error");
    });
  }

  function closeModal() {
    userModal.classList.remove('active');
  }

  // Guardar cambios en Firestore
  saveBtn.addEventListener("click", () => {
    const rows = document.querySelectorAll("#tableBody tr");
    let updates = [];
    let hasErrors = false;
    
    saveBtn.disabled = true;
    loadingIndicator.style.display = "block";
    loadingIndicator.querySelector("p").textContent = "Guardando cambios...";

    rows.forEach(row => {
      const docId = row.getAttribute("data-id");
      const cells = row.querySelectorAll("td[contenteditable='true']");
      let actualizacion = {};
      let rowHasErrors = false;
      
      cells.forEach(cell => {
        const key = cell.getAttribute("data-key");
        const nuevoValor = cell.textContent.trim();
        const valorOriginal = datosLocal[docId][key];
        
        // Validar el campo antes de guardar
        if (!validarCampo(cell, key)) {
          rowHasErrors = true;
          hasErrors = true;
          return;
        }
        
        // Solo actualizar si el valor cambió
        if (formatearValor(valorOriginal) !== nuevoValor) {
          // Intentar convertir valores si es necesario
          if (valorOriginal && typeof valorOriginal.toDate === 'function') {
            // Es un timestamp - intentar convertir de vuelta
            try {
              const partes = nuevoValor.split('/');
              if (partes.length === 3) {
                const fecha = new Date(partes[2], partes[1] - 1, partes[0]);
                if (!isNaN(fecha.getTime())) {
                  actualizacion[key] = firebase.firestore.Timestamp.fromDate(fecha);
                } else {
                  actualizacion[key] = nuevoValor;
                }
              } else {
                actualizacion[key] = nuevoValor;
              }
            } catch (e) {
              console.error("Error convirtiendo fecha: ", e);
              actualizacion[key] = nuevoValor; // Guardar como string si falla la conversión
            }
          } else if (typeof valorOriginal === 'number') {
            actualizacion[key] = Number(nuevoValor) || nuevoValor;
          } else if (typeof valorOriginal === 'boolean') {
            actualizacion[key] = (nuevoValor.toLowerCase() === 'true');
          } else {
            actualizacion[key] = nuevoValor;
          }
        }
      });
      
      if (rowHasErrors) {
        showNotification("Corrija los errores antes de guardar", "error");
        hasErrors = true;
        return;
      }
      
      if (Object.keys(actualizacion).length > 0) {
        updates.push(
          db.collection("registros").doc(docId).update(actualizacion)
            .then(() => {
              console.log("Documento actualizado: ", docId);
              // Actualizar datos locales con los nuevos valores
              datosLocal[docId] = {...datosLocal[docId], ...actualizacion};
            })
            .catch(error => {
              console.error("Error actualizando documento ", docId, ": ", error);
              throw error;
            })
        );
      }
    });
    
    if (hasErrors) {
      loadingIndicator.style.display = "none";
      saveBtn.disabled = false;
      return;
    }
    
    if (updates.length === 0) {
      loadingIndicator.style.display = "none";
      showNotification("No hay cambios para guardar");
      cambiosPendientes = false;
      return;
    }
    
    Promise.all(updates)
      .then(() => {
        loadingIndicator.style.display = "none";
        showNotification("Cambios guardados correctamente ✅");
        cambiosPendientes = false;
      })
      .catch(error => {
        loadingIndicator.style.display = "none";
        console.error("Error guardando cambios: ", error);
        showNotification("Error guardando cambios: " + error.message, "error");
        saveBtn.disabled = false;
      });
  });

  function handleExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
  
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
  
      // Asumimos que la primera fila son los encabezados
      excelHeaders = jsonData[0];
      const rows = jsonData.slice(1);
  
      // Convertir a array de objetos
      excelData = rows.map(row => {
        let obj = {};
        excelHeaders.forEach((header, i) => {
          obj[header] = row[i] || '';
        });
        return obj;
      });
  
      // Mostrar el modal de opciones
      document.getElementById('excelModal').classList.add('active');
    };
    reader.readAsArrayBuffer(file);
  }
  
  function closeExcelModal() {
    document.getElementById('excelModal').classList.remove('active');
  }
  
  function processExcelData(mode) {
    closeExcelModal();
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
  
    progressContainer.style.display = 'block';
    progressStatus.textContent = 'Iniciando...';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressPercent.textContent = '0%';
  
    // Si mode es 'replace', primero eliminamos todos los documentos existentes
    if (mode === 'replace') {
      deleteAllDocuments().then(() => {
        uploadDataWithProgress();
      }).catch(error => {
        console.error("Error eliminando documentos: ", error);
        showNotification("Error eliminando documentos: " + error.message, "error");
        progressContainer.style.display = 'none';
      });
    } else {
      // Para el modo 'add', necesitamos obtener los DNIs existentes primero
      getExistingDnis().then(existingDnis => {
        uploadDataWithProgress(existingDnis);
      }).catch(error => {
        console.error("Error obteniendo DNIs existentes: ", error);
        showNotification("Error obteniendo DNIs existentes: " + error.message, "error");
        progressContainer.style.display = 'none';
      });
    }
  
    function uploadDataWithProgress(existingDnis = new Set()) {
      let processed = 0;
      const total = excelData.length;
      const batch = db.batch();
      const registrosRef = db.collection("registros");
      
      const processNext = () => {
        if (processed >= total) {
          // Commit el batch final
          batch.commit()
            .then(() => {
              progressStatus.textContent = 'Completado!';
              progressBar.textContent = '100%';
              progressBar.style.width = '100%';
              progressPercent.textContent = '100%';
              
              showNotification("Datos importados correctamente ✅");
              // Recargar la tabla después de un breve retraso
              setTimeout(() => {
                progressContainer.style.display = 'none';
                cargarTabla();
              }, 1000);
            })
            .catch(error => {
              console.error("Error committing batch: ", error);
              showNotification("Error importando datos: " + error.message, "error");
              progressContainer.style.display = 'none';
            });
          return;
        }
  
        const data = excelData[processed];
        
        // Para el modo 'add', verificar si el DNI ya existe
        if (mode === 'add' && data.dni && existingDnis.has(data.dni.toString())) {
          // Saltar este registro porque ya existe
          processed++;
          const percent = Math.round((processed / total) * 100);
          progressBar.style.width = percent + '%';
          progressBar.textContent = percent + '%';
          progressPercent.textContent = percent + '%';
          progressStatus.textContent = `Procesando ${processed} de ${total} registros`;
          
          // Procesar el siguiente
          setTimeout(processNext, 10);
          return;
        }
        
        // Crear un nuevo documento
        const nuevoDocRef = registrosRef.doc();
        
        // Añadir timestamp si no existe
        if (!data.fecha) {
          data.fecha = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        // Añadir al batch
        batch.set(nuevoDocRef, data);
        
        // Actualizar progreso
        processed++;
        const percent = Math.round((processed / total) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        progressPercent.textContent = percent + '%';
        progressStatus.textContent = `Procesando ${processed} de ${total} registros`;
  
        // Si el batch tiene 500 operaciones, commit y crear nuevo batch
        if (processed % 500 === 0) {
          batch.commit()
            .then(() => {
              // Continuar con el siguiente lote
              setTimeout(processNext, 10);
            })
            .catch(error => {
              console.error("Error committing batch: ", error);
              showNotification("Error importando datos: " + error.message, "error");
              progressContainer.style.display = 'none';
            });
        } else {
          // Procesar el siguiente con un pequeño retraso
          setTimeout(processNext, 10);
        }
      };
  
      processNext();
    }
  }
  
  // Función para obtener todos los DNIs existentes
  async function getExistingDnis() {
    const snapshot = await db.collection("registros").get();
    const existingDnis = new Set();
    
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.dni) {
        existingDnis.add(data.dni.toString());
      }
    });
    
    return existingDnis;
  }
  
  // Función para eliminar todos los documentos
  async function deleteAllDocuments() {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    
    progressStatus.textContent = 'Eliminando documentos existentes...';
    
    // Obtener todos los documentos
    const snapshot = await db.collection("registros").get();
    const total = snapshot.size;
    let deleted = 0;
    
    // Eliminar en lotes de 500
    const batch = db.batch();
    const batchSize = 500;
    let batchCount = 0;
    
    snapshot.forEach(doc => {
      batch.delete(doc.ref);
      deleted++;
      batchCount++;
      
      const percent = Math.round((deleted / total) * 100);
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      progressPercent.textContent = percent + '%';
      
      // Si el batch alcanza el tamaño máximo, commit y crear nuevo batch
      if (batchCount >= batchSize) {
        batch.commit();
        batchCount = 0;
      }
    });
    
    // Commit el batch final
    if (batchCount > 0) {
      await batch.commit();
    }
    
    return Promise.resolve();
  }
  
  function exportToExcel() {
    loadingIndicator.style.display = "block";
    loadingIndicator.querySelector("p").textContent = "Preparando datos para exportar...";
  
    // Obtener todos los registros
    db.collection("registros").get().then(snapshot => {
      if (snapshot.empty) {
        showNotification("No hay datos para exportar", "error");
        loadingIndicator.style.display = "none";
        return;
      }
  
      // Obtener todas las asistencias para contar por DNI
      db.collection("asistencias").get().then(asistenciasSnapshot => {
        const asistenciasPorDni = {};
  
        asistenciasSnapshot.forEach(doc => {
          const asistencia = doc.data();
          const dni = asistencia.dni;
  
          if (dni) {
            if (!asistenciasPorDni[dni]) {
              asistenciasPorDni[dni] = new Set();
            }
  
            // Procesar la fecha para contar una por día
            if (asistencia.fecha && typeof asistencia.fecha.toDate === 'function') {
              const fecha = asistencia.fecha.toDate();
              const fechaStr = fecha.toISOString().split('T')[0]; // YYYY-MM-DD
              asistenciasPorDni[dni].add(fechaStr);
            }
          }
        });
  
        // Convertir el Set a la cuenta
        const totalAsistenciasPorDni = {};
        Object.keys(asistenciasPorDni).forEach(dni => {
          totalAsistenciasPorDni[dni] = asistenciasPorDni[dni].size;
        });
  
        // Obtener todas las claves únicas de todos los documentos
        const allKeysSet = new Set();
        snapshot.forEach(doc => {
          Object.keys(doc.data()).forEach(key => allKeysSet.add(key));
        });
  
        // Eliminar cualquier campo de asistencias que venga de los registros
        allKeysSet.delete('totalAsistencias');
        allKeysSet.delete('Asistencias');
  
        // Convertir a array
        let allKeys = Array.from(allKeysSet);
  
        // Opcional: mover 'dni' a primera columna y 'Asistencias' después
        const dniIndex = allKeys.indexOf('dni');
        if (dniIndex > -1) {
          allKeys.splice(dniIndex, 1); // quitar 'dni' de su posición
          allKeys.unshift('dni'); // poner al inicio
        }
  
        // Insertar 'Asistencias' justo después de 'dni'
        const dniPosition = allKeys.indexOf('dni');
        allKeys.splice(dniPosition + 1, 0, 'Asistencias');
  
        // Crear datos para exportar
        const dataToExport = [allKeys]; // Encabezados
  
        // Llenar los datos
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = [];
  
          allKeys.forEach(header => {
            if (header === 'Asistencias') {
              const dni = data.dni;
              const asistencias = totalAsistenciasPorDni[dni] || 0;
              row.push(asistencias);
            } else {
              row.push(formatearValor(data[header]));
            }
          });
  
          dataToExport.push(row);
        });
  
        // Crear libro de trabajo de Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(dataToExport);
  
        // Ajustar el ancho de las columnas
        const colWidths = allKeys.map(() => ({ wch: 20 }));
        ws['!cols'] = colWidths;
  
        XLSX.utils.book_append_sheet(wb, ws, "registros");
  

        // Exportar a archivo
        XLSX.writeFile(wb, `registros_${new Date().toISOString().split('T')[0]}.xlsx`);

        loadingIndicator.style.display = "none";
        showNotification("Datos exportados correctamente ✅");

      }).catch(error => {
        loadingIndicator.style.display = "none";
        console.error("Error obteniendo asistencias: ", error);
        showNotification("Error exportando datos: " + error.message, "error");
      });

    }).catch(error => {
      loadingIndicator.style.display = "none";
      console.error("Error exportando datos: ", error);
      showNotification("Error exportando datos: " + error.message, "error");
    });
  }

  // Confirmar antes de salir si hay cambios sin guardar
  window.addEventListener('beforeunload', (e) => {
    if (cambiosPendientes) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // Cerrar modal al hacer clic fuera de él
  userModal.addEventListener('click', (e) => {
    if (e.target === userModal) {
      closeModal();
    }
  });

  // Cerrar modal de calendario al hacer clic fuera
  calendarModal.addEventListener('click', (e) => {
    if (e.target === calendarModal) {
      closeCalendarModal();
    }
  });

  // Cerrar modal de Excel al hacer clic fuera
  document.getElementById('excelModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('excelModal')) {
      closeExcelModal();
    }
  });

  // Cargar la primera pestaña al inicio
  window.onload = () => {
    // Inicializar con la pestaña de alumnos activa
    cambiarTab('alumnos');
  };
</script>

</body>
</html>        
