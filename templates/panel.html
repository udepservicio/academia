<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestión de Alumnos</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="https://www.udep.edu.pe/dircom/wp-content/uploads/sites/20/2023/03/favicon-udep.jpg" type="image/png" />
<style>
  :root {
    --primary: #1E3A5F;
    --secondary: #4A6FA5;
    --accent: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --light: #f8f9fa;
    --dark: #343a40;
    --gray: #6c757d;
    --border: #dee2e6;
    --background: #f5f7fa;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--background);
    color: #333;
    line-height: 1.6;
    padding: 0;
    margin: 0;
    font-size: 0.9rem;
  }
  
  .container {
    display: grid;
    grid-template-columns: 220px 1fr;
    min-height: 100vh;
  }
  
  /* Sidebar */
  .sidebar {
    background: var(--primary);
    color: white;
    padding: 20px 0;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  
  .logo {
    padding: 0 20px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .logo h1 {
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .logo i {
    font-size: 1.5rem;
  }
  
  .menu-toggle {
    display: none;
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
  }
  
  .tabs {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 0 10px;
  }
  
  .tab-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.3s;
    text-align: left;
    font-size: 0.85rem;
  }
  
  .tab-btn:hover {
    background: rgba(255,255,255,0.1);
    color: white;
  }
  
  .tab-btn.active {
    background: var(--secondary);
    color: white;
  }
  
  .tab-btn i {
    width: 18px;
    text-align: center;
    font-size: 0.9rem;
  }
  
  /* Main Content */
  .main-content {
    padding: 15px;
    overflow: auto;
  }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  
  .header h2 {
    color: var(--primary);
    font-weight: 600;
    font-size: 1.3rem;
  }
  
  .live-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--danger);
    font-weight: 500;
  }
  
  .live-dot {
    width: 10px;
    height: 10px;
    background-color: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 6px rgba(220, 53, 69, 0);
    }
    100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
  }
  
  /* Actions */
  .actions {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  
  .btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
    font-size: 0.8rem;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: #2c5282;
  }
  
  .btn-success {
    background: var(--accent);
    color: white;
  }
  
  .btn-success:hover {
    background: #218838;
  }
  
  .btn-info {
    background: #17a2b8;
    color: white;
  }
  
  .btn-info:hover {
    background: #138496;
  }
  
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  
  .btn-danger:hover {
    background: #bd2130;
  }
  
  /* Table */
  .table-container {
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.05);
    overflow: auto;
    margin-bottom: 15px;
    max-height: 70vh;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  th, td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    font-size: 0.8rem;
    height: 32px;
  }
  
  th {
    background-color: #f8f9fa;
    color: var(--dark);
    font-weight: 600;
    position: sticky;
    top: 0;
    box-shadow: 0 1px 0 var(--border);
    white-space: nowrap;
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background-color: #f8f9fa;
  }
  
  td[contenteditable="true"] {
    background: #fff;
    outline: 1px solid var(--primary);
    border-radius: 3px;
    padding: 6px 8px;
  }
  
  .actions-cell {
    display: flex;
    gap: 6px;
    white-space: nowrap;
  }
  
  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray);
    transition: color 0.3s;
    font-size: 0.9rem;
    padding: 3px;
    border-radius: 3px;
  }
  
  .icon-btn:hover {
    color: var(--primary);
    background: rgba(0,0,0,0.05);
  }
  
  .delete-btn:hover {
    color: var(--danger);
  }
  
  /* Estadísticas */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  
  .stat-card h3 {
    color: var(--primary);
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1rem;
  }
  
  .chart-container {
    position: relative;
    height: 250px;
  }
  
  /* User Detail Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  
  .modal-overlay.active {
    opacity: 1;
    pointer-events: all;
  }
  
  .modal {
    background: white;
    border-radius: 6px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--border);
  }
  
  .modal-header h3 {
    color: var(--primary);
    margin: 0;
    font-size: 1.1rem;
  }
  
  .close-btn {
    background: none;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
    color: var(--gray);
  }
  
  .modal-body {
    padding: 15px;
  }
  
  .user-info {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 15px;
  }
  
  .info-item {
    margin-bottom: 8px;
  }
  
  .info-label {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 3px;
    font-size: 0.8rem;
  }
  
  .info-value {
    color: var(--gray);
    font-size: 0.85rem;
  }
  
  .user-courses {
    margin-top: 15px;
  }
  
  .user-courses h4 {
    margin-bottom: 10px;
    color: var(--primary);
    font-size: 0.95rem;
  }
  
  .course-card {
    background: #f8f9fa;
    border-radius: 5px;
    padding: 12px;
    margin-bottom: 12px;
  }
  
  .course-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  
  .course-title {
    font-weight: 600;
    color: var(--primary);
    font-size: 0.85rem;
  }
  
  .course-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 8px;
  }
  
  .stat {
    text-align: center;
    padding: 8px;
    background: white;
    border-radius: 5px;
  }
  
  .stat-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary);
  }
  
  .stat-label {
    font-size: 0.7rem;
    color: var(--gray);
  }
  
  /* Notifications */
  .notification {
    position: fixed;
    top: 15px;
    right: 15px;
    padding: 12px 15px;
    border-radius: 5px;
    color: white;
    opacity: 0;
    transition: opacity 0.5s;
    z-index: 1000;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    font-size: 0.85rem;
  }
  
  .success {
    background: var(--accent);
  }
  
  .error {
    background: var(--danger);
  }
  
  /* Loading */
  .loading {
    display: none;
    text-align: center;
    margin: 15px;
  }
  
  .spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    width: 25px;
    height: 25px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Responsive */
  @media (max-width: 900px) {
    .container {
      grid-template-columns: 1fr;
      position: relative;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 1000;
      transform: translateX(-100%);
    }
    
    .sidebar.active {
      transform: translateX(0);
    }
    
    .menu-toggle {
      display: block;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1001;
      background: var(--primary);
      border-radius: 5px;
      padding: 5px 10px;
    }
    
    .main-content {
      padding-top: 60px;
    }
    
    .actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    .btn {
      justify-content: center;
    }
    
    .user-info {
      grid-template-columns: 1fr;
    }
    
    .course-stats {
      grid-template-columns: 1fr;
    }
    
    .stats-container {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<!-- SheetJS (para exportar a Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<button class="menu-toggle" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <h1><i class="fas fa-user-graduate"></i> Alumnos</h1>
      <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="tabs">
      <button class="tab-btn" onclick="cambiarTab('asistencias')">
        <i class="fas fa-clipboard-check"></i> Asistencias
      </button>
      <button class="tab-btn active" onclick="cambiarTab('alumnos')">
        <i class="fas fa-users"></i> Alumnos
      </button>
      <button class="tab-btn" onclick="cambiarTab('estadisticas')">
        <i class="fas fa-chart-pie"></i> Estadísticas
      </button>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h2 id="tableTitle">Gestión de Alumnos</h2>
      <div class="live-indicator">
        <div class="live-dot"></div>
        <span>En vivo</span>
      </div>
    </div>
    
    <div id="content-container">
      <!-- Contenido para la pestaña de Alumnos -->
      <div id="alumnos-content">
        <div class="actions">
          <button class="btn btn-primary" onclick="agregarFila()">
            <i class="fas fa-plus"></i> Agregar Fila
          </button>
          <button class="btn btn-success" id="saveBtn" disabled>
            <i class="fas fa-save"></i> Guardar Cambios
          </button>
          <button class="btn btn-info" onclick="exportToExcel()">
            <i class="fas fa-file-export"></i> Exportar a Excel
          </button>
        </div>
        
        <div class="table-container">
          <table id="dataTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Contenido para la pestaña de Asistencias -->
      <div id="asistencias-content" style="display: none;">
        <div class="table-container">
          <table id="asistenciasTable">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>DNI</th>
                <th>Total Asistencias</th>
                <th>Última Asistencia</th>
              </tr>
            </thead>
            <tbody id="asistenciasBody">
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Contenido para la pestaña de Estadísticas -->
      <div id="estadisticas-content" style="display: none;">
        <div class="stats-container">
          <div class="stat-card">
            <h3>Distribución por Carrera</h3>
            <div class="chart-container">
              <canvas id="carreraChart"></canvas>
            </div>
          </div>
          
          <div class="stat-card">
            <h3>Distribución por Región</h3>
            <div class="chart-container">
              <canvas id="regionChart"></canvas>
            </div>
          </div>
          
          <div class="stat-card">
            <h3>Distribución por Modalidad</h3>
            <div class="chart-container">
              <canvas id="modalidadChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="loading" id="loadingIndicator">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
  </div>
</div>

<!-- Modal para detalles de usuario -->
<div class="modal-overlay" id="userModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Detalles del Alumno</h3>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="userModalBody">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
  // Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCohuXeXlI6z8R0RXEIWeL4atI9zkpj_i4",
    authDomain: "academia-udep-43440.firebaseapp.com",
    projectId: "academia-udep-43440",
    storageBucket: "academia-udep-43440.firebasestorage.app",
    messagingSenderId: "853553587165",
    appId: "1:853553587165:web:d2fd928f520d51276e4c34"
  };
  
  // Inicializar Firebase
  try {
    firebase.initializeApp(firebaseConfig);
  } catch (error) {
    console.error("Error inicializando Firebase: ", error);
    showNotification("Error inicializando Firebase", "error");
  }
  
  const db = firebase.firestore();
  let coleccionActual = "alumnos";
  let datosLocal = {};
  let cambiosPendientes = false;
  let allKeys = [];
  let unsubscribe = null;
  let charts = {};
  let alumnosData = [];
  let asistenciasData = [];

  // Referencias a elementos del DOM
  const saveBtn = document.getElementById("saveBtn");
  const loadingIndicator = document.getElementById("loadingIndicator");
  const notificationElement = document.getElementById("notification");
  const tableTitle = document.getElementById("tableTitle");
  const userModal = document.getElementById("userModal");
  const userModalBody = document.getElementById("userModalBody");
  const alumnosContent = document.getElementById("alumnos-content");
  const asistenciasContent = document.getElementById("asistencias-content");
  const estadisticasContent = document.getElementById("estadisticas-content");
  const sidebar = document.getElementById("sidebar");

  function toggleSidebar() {
    sidebar.classList.toggle('active');
  }

  function showNotification(message, type = "success") {
    notificationElement.textContent = message;
    notificationElement.className = `notification ${type}`;
    notificationElement.style.opacity = 1;
    
    setTimeout(() => {
      notificationElement.style.opacity = 0;
    }, 3000);
  }

  function cambiarTab(tab) {
    if (cambiosPendientes && tab !== coleccionActual) {
      if (!confirm("Tienes cambios sin guardar. ¿Estás seguro de que quieres cambiar de pestaña?")) {
        return;
      }
    }
    
    coleccionActual = tab;
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelector(`.tab-btn[onclick="cambiarTab('${tab}')"]`).classList.add("active");
    
    // Ocultar todos los contenidos primero
    alumnosContent.style.display = 'none';
    asistenciasContent.style.display = 'none';
    estadisticasContent.style.display = 'none';
    
    // Actualizar título y contenido según la pestaña
    if (tab === 'estadisticas') {
      tableTitle.textContent = 'Estadísticas de Alumnos';
      estadisticasContent.style.display = 'block';
      cargarEstadisticas();
    } else if (tab === 'asistencias') {
      tableTitle.textContent = 'Gestión de Asistencias';
      asistenciasContent.style.display = 'block';
      cargarAsistencias();
    } else {
      tableTitle.textContent = 'Gestión de Alumnos';
      alumnosContent.style.display = 'block';
      
      // Cargar datos de la nueva colección
      cargarTabla();
    }
    
    // En móvil, cerrar el sidebar al cambiar de pestaña
    if (window.innerWidth <= 900) {
      sidebar.classList.remove('active');
    }
  }

  function formatearValor(valor) {
    if (valor === null || valor === undefined) return "";
    
    // Si es un timestamp de Firestore
    if (valor && typeof valor.toDate === 'function') {
      return valor.toDate().toLocaleString("es-ES");
    }
    
    // Si es un objeto (pero no un timestamp)
    if (typeof valor === 'object') {
      return JSON.stringify(valor);
    }
    
    return valor;
  }

  function cargarTabla() {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");
    
    head.innerHTML = "";
    body.innerHTML = "";
    datosLocal = {};
    cambiosPendientes = false;
    saveBtn.disabled = true;
    
    loadingIndicator.style.display = "block";

    // Cancelar suscripción anterior si existe
    if (unsubscribe) {
      unsubscribe();
    }

    // Usar onSnapshot para sincronización en tiempo real
    unsubscribe = db.collection("registros").onSnapshot(snapshot => {
      loadingIndicator.style.display = "none";
      
      head.innerHTML = "";
      body.innerHTML = "";
      
      if (snapshot.empty) {
        head.innerHTML = "<tr><th colspan='3'>No hay datos en esta colección</th></tr>";
        return;
      }

      // Obtener todas las claves únicas de todos los documentos
      allKeys = new Set();
      snapshot.forEach(doc => {
        Object.keys(doc.data()).forEach(key => allKeys.add(key));
      });
      
      // Convertir a array y ordenar según el orden deseado
      allKeys = Array.from(allKeys);
      
      // Orden personalizado para la colección registros
      const ordenDeseado = ['nombre', 'dni', 'carrera', 'region', 'modalidad', 'celular', 'fecha'];
      allKeys = ordenDeseado.filter(key => allKeys.includes(key));
      
      // Agregar cualquier campo adicional que no esté en el orden deseado
      const camposAdicionales = allKeys.filter(key => !ordenDeseado.includes(key));
      allKeys = allKeys.concat(camposAdicionales);
      
      // Crear encabezados
      let trHead = "<tr>";
      allKeys.forEach(k => { 
        trHead += `<th>${k}</th>`; 
      });
      
      // Agregar columna de acciones
      trHead += "<th>Acciones</th></tr>";
      
      head.innerHTML = trHead;

      // Crear filas
      snapshot.forEach(doc => {
        const data = doc.data();
        datosLocal[doc.id] = {...data}; // Guardar copia local
        
        let tr = `<tr data-id="${doc.id}">`;
        
        allKeys.forEach(k => {
          const valor = data[k];
          tr += `<td contenteditable="true" data-key="${k}" oninput="habilitarGuardado()">${formatearValor(valor)}</td>`;
        });
        
        // Botones de acción
        tr += `<td class="actions-cell">`;
        tr += `<button class="icon-btn" onclick="verDetallesAlumno('${doc.id}')" title="Ver detalles">
                  <i class="fas fa-eye"></i>
               </button>`;
        tr += `<button class="icon-btn delete-btn" onclick="eliminarFila('${doc.id}', 'registros')" title="Eliminar">
                  <i class="fas fa-trash"></i>
               </button>
              </td>`;
        
        tr += "</tr>";
        body.innerHTML += tr;
      });
    }, error => {
      loadingIndicator.style.display = "none";
      console.error("Error cargando datos: ", error);
      showNotification("Error cargando datos: " + error.message, "error");
    });
  }

  function cargarAsistencias() {
    loadingIndicator.style.display = "block";
    
    // Obtener todos los registros de alumnos
    db.collection("registros").get().then(registrosSnapshot => {
      alumnosData = [];
      registrosSnapshot.forEach(doc => {
        alumnosData.push({ id: doc.id, ...doc.data() });
      });
      
      // Obtener todas las asistencias
      return db.collection("asistencias").get();
    }).then(asistenciasSnapshot => {
      asistenciasData = [];
      asistenciasSnapshot.forEach(doc => {
        asistenciasData.push({ id: doc.id, ...doc.data() });
      });
      
      // Procesar datos para mostrar asistencias por alumno
      mostrarAsistenciasPorAlumno();
      loadingIndicator.style.display = "none";
    }).catch(error => {
      loadingIndicator.style.display = "none";
      console.error("Error cargando asistencias: ", error);
      showNotification("Error cargando asistencias: " + error.message, "error");
    });
  }

  function mostrarAsistenciasPorAlumno() {
    const asistenciasBody = document.getElementById("asistenciasBody");
    asistenciasBody.innerHTML = "";
    
    // Contar asistencias por DNI
    const asistenciasPorDni = {};
    asistenciasData.forEach(asistencia => {
      const dni = asistencia.dni;
      if (!asistenciasPorDni[dni]) {
        asistenciasPorDni[dni] = {
          count: 0,
          lastDate: null
        };
      }
      
      asistenciasPorDni[dni].count++;
      
      // Obtener la fecha más reciente
      if (asistencia.fecha && typeof asistencia.fecha.toDate === 'function') {
        const fecha = asistencia.fecha.toDate();
        if (!asistenciasPorDni[dni].lastDate || fecha > asistenciasPorDni[dni].lastDate) {
          asistenciasPorDni[dni].lastDate = fecha;
        }
      }
    });
    
    // Crear filas para cada alumno
    alumnosData.forEach(alumno => {
      const dni = alumno.dni;
      const asistencias = asistenciasPorDni[dni] || { count: 0, lastDate: null };
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${alumno.nombre || 'No especificado'}</td>
        <td>${dni || 'No especificado'}</td>
        <td>${asistencias.count}</td>
        <td>${asistencias.lastDate ? asistencias.lastDate.toLocaleDateString() : 'Nunca'}</td>
      `;
      
      asistenciasBody.appendChild(tr);
    });
  }

  function cargarEstadisticas() {
    loadingIndicator.style.display = "block";
    
    // Obtener todos los alumnos
    db.collection('registros').get().then(snapshot => {
      loadingIndicator.style.display = "none";
      
      if (snapshot.empty) {
        showNotification("No hay datos para mostrar estadísticas", "error");
        return;
      }
      
      const datos = [];
      snapshot.forEach(doc => {
        datos.push(doc.data());
      });
      
      // Procesar datos para estadísticas
      procesarDatosEstadisticas(datos);
    }).catch(error => {
      loadingIndicator.style.display = "none";
      console.error("Error cargando estadísticas: ", error);
      showNotification("Error cargando estadísticas: " + error.message, "error");
    });
  }

  function procesarDatosEstadisticas(datos) {
    // Estadísticas por carrera
    const carreras = {};
    datos.forEach(alumno => {
      const carrera = alumno.carrera || 'Sin especificar';
      carreras[carrera] = (carreras[carrera] || 0) + 1;
    });
    
    // Estadísticas por región
    const regiones = {};
    datos.forEach(alumno => {
      const region = alumno.region || 'Sin especificar';
      regiones[region] = (regiones[region] || 0) + 1;
    });
    
    // Estadísticas por modalidad
    const modalidades = {};
    datos.forEach(alumno => {
      const modalidad = alumno.modalidad || 'Sin especificar';
      modalidades[modalidad] = (modalidades[modalidad] || 0) + 1;
    });
    
    // Crear gráficos
    crearGrafico('carreraChart', 'Carreras', carreras);
    crearGrafico('regionChart', 'Regiones', regiones);
    crearGrafico('modalidadChart', 'Modalidades', modalidades);
  }

  function crearGrafico(canvasId, titulo, datos) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Destruir gráfico existente si hay uno
    if (charts[canvasId]) {
      charts[canvasId].destroy();
    }
    
    // Preparar datos para el gráfico
    const labels = Object.keys(datos);
    const values = Object.values(datos);
    
    // Colores para el gráfico
    const backgroundColors = [
      '#1E3A5F', '#4A6FA5', '#28a745', '#dc3545', '#ffc107', 
      '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14', '#20c997'
    ];
    
    charts[canvasId] = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: backgroundColors,
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 15,
              padding: 15
            }
          },
          title: {
            display: true,
            text: titulo
          }
        }
      }
    });
  }

  function habilitarGuardado() {
    cambiosPendientes = true;
    saveBtn.disabled = false;
  }

  function agregarFila() {
    // Crear un nuevo documento con valores por defecto
    const nuevoDocRef = db.collection("registros").doc();
    const datosPorDefecto = {
      nombre: '',
      dni: '',
      carrera: '',
      region: '',
      modalidad: '',
      celular: '',
      fecha: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    nuevoDocRef.set(datosPorDefecto)
      .then(() => {
        showNotification("Nueva fila agregada");
      })
      .catch(error => {
        console.error("Error agregando fila: ", error);
        showNotification("Error agregando fila: " + error.message, "error");
      });
  }

  function eliminarFila(docId, collectionName = "registros") {
    if (confirm("¿Estás seguro de que deseas eliminar esta fila?")) {
      db.collection(collectionName).doc(docId).delete()
        .then(() => {
          showNotification("Fila eliminada correctamente");
        })
        .catch(error => {
          console.error("Error eliminando fila: ", error);
          showNotification("Error eliminando fila: " + error.message, "error");
        });
    }
  }

  function verDetallesAlumno(userId) {
    loadingIndicator.style.display = "block";
    
    // Obtener datos del alumno desde la colección "registros"
    db.collection('registros').doc(userId).get().then(userDoc => {
      if (!userDoc.exists) {
        showNotification("Alumno no encontrado", "error");
        loadingIndicator.style.display = "none";
        return;
      }
      
      const userData = userDoc.data();
      
      // Construir el modal con la información del alumno
      userModalBody.innerHTML = `
        <div class="user-info">
          <div class="info-item">
            <div class="info-label">Nombre</div>
            <div class="info-value">${userData.nombre || 'No especificado'}</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">DNI</div>
            <div class="info-value">${userData.dni || 'No especificado'}</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Carrera</div>
            <div class="info-value">${userData.carrera || 'No especificado'}</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Región</div>
            <div class="info-value">${userData.region || 'No especificado'}</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Modalidad</div>
            <div class="info-value">${userData.modalidad || 'No especificado'}</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Celular</div>
            <div class="info-value">${userData.celular || 'No especificado'}</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Fecha de registro</div>
            <div class="info-value">${userData.fecha ? userData.fecha.toDate().toLocaleDateString() : 'No especificado'}</div>
          </div>
        </div>
      `;
      
      // Mostrar el modal
      userModal.classList.add('active');
      loadingIndicator.style.display = "none";
    })
    .catch(error => {
      loadingIndicator.style.display = "none";
      console.error("Error obteniendo alumno: ", error);
      showNotification("Error obteniendo datos del alumno", "error");
    });
  }

  function closeModal() {
    userModal.classList.remove('active');
  }

  // Guardar cambios en Firestore
  saveBtn.addEventListener("click", () => {
    const rows = document.querySelectorAll("#tableBody tr");
    let updates = [];
    
    saveBtn.disabled = true;
    loadingIndicator.style.display = "block";
    loadingIndicator.querySelector("p").textContent = "Guardando cambios...";

    rows.forEach(row => {
      const docId = row.getAttribute("data-id");
      const cells = row.querySelectorAll("td[contenteditable='true']");
      let actualizacion = {};
      
      cells.forEach(cell => {
        const key = cell.getAttribute("data-key");
        const nuevoValor = cell.textContent;
        const valorOriginal = datosLocal[docId][key];
        
        // Solo actualizar si el valor cambió
        if (formatearValor(valorOriginal) !== nuevoValor) {
          // Intentar convertir valores si es necesario
          if (valorOriginal && typeof valorOriginal.toDate === 'function') {
            // Es un timestamp - intentar convertir de vuelta
            try {
              const fecha = new Date(nuevoValor);
              actualizacion[key] = firebase.firestore.Timestamp.fromDate(fecha);
            } catch (e) {
              console.error("Error convirtiendo fecha: ", e);
              actualizacion[key] = nuevoValor; // Guardar como string si falla la conversión
            }
          } else if (typeof valorOriginal === 'number') {
            actualizacion[key] = Number(nuevoValor) || nuevoValor;
          } else if (typeof valorOriginal === 'boolean') {
            actualizacion[key] = (nuevoValor.toLowerCase() === 'true');
          } else {
            actualizacion[key] = nuevoValor;
          }
        }
      });
      
      if (Object.keys(actualizacion).length > 0) {
        updates.push(
          db.collection("registros").doc(docId).update(actualizacion)
            .then(() => {
              console.log("Documento actualizado: ", docId);
              // Actualizar datos locales con los nuevos valores
              datosLocal[docId] = {...datosLocal[docId], ...actualizacion};
            })
            .catch(error => {
              console.error("Error actualizando documento ", docId, ": ", error);
              throw error;
            })
        );
      }
    });
    
    if (updates.length === 0) {
      loadingIndicator.style.display = "none";
      showNotification("No hay cambios para guardar");
      cambiosPendientes = false;
      return;
    }
    
    Promise.all(updates)
      .then(() => {
        loadingIndicator.style.display = "none";
        showNotification("Cambios guardados correctamente ✅");
        cambiosPendientes = false;
      })
      .catch(error => {
        loadingIndicator.style.display = "none";
        console.error("Error guardando cambios: ", error);
        showNotification("Error guardando cambios: " + error.message, "error");
        saveBtn.disabled = false;
      });
  });

  function exportToExcel() {
    loadingIndicator.style.display = "block";
    loadingIndicator.querySelector("p").textContent = "Preparando datos para exportar...";
    
    // Obtener todos los datos de la colección actual
    db.collection("registros").get().then(snapshot => {
      if (snapshot.empty) {
        showNotification("No hay datos para exportar", "error");
        loadingIndicator.style.display = "none";
        return;
      }
      
      const dataToExport = [];
      
      // Crear encabezados
      const headers = allKeys;
      dataToExport.push(headers);
      
      // Llenar los datos
      snapshot.forEach(doc => {
        const data = doc.data();
        const row = [];
        
        headers.forEach(header => {
          row.push(formatearValor(data[header]));
        });
        
        dataToExport.push(row);
      });
      
      // Crear libro de trabajo de Excel
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      
      // Ajustar el ancho de las columnas
      const colWidths = headers.map(() => ({ wch: 20 }));
      ws['!cols'] = colWidths;
      
      XLSX.utils.book_append_sheet(wb, ws, "registros");
      
      // Exportar a archivo
      XLSX.writeFile(wb, `registros_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      loadingIndicator.style.display = "none";
      showNotification("Datos exportados correctamente ✅");
    }).catch(error => {
      loadingIndicator.style.display = "none";
      console.error("Error exportando datos: ", error);
      showNotification("Error exportando datos: " + error.message, "error");
    });
  }

  // Confirmar antes de salir si hay cambios sin guardar
  window.addEventListener('beforeunload', (e) => {
    if (cambiosPendientes) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // Cerrar modal al hacer clic fuera de él
  userModal.addEventListener('click', (e) => {
    if (e.target === userModal) {
      closeModal();
    }
  });

  // Cargar la primera pestaña al inicio
  window.onload = () => {
    // Inicializar con la pestaña de alumnos activa
    cambiarTab('alumnos');
  };
</script>

</body>
</html>


